<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Attendance Calendar</title>
    {% load static %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'images/icon.png' %}">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<style>

/* Container styling */
        #indicator-container {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }

        /* Circle styling */
        .circle {
            width: 20px;
            height: 20px;
            border-radius: 10%;
            display: inline-block;
        }

        /* Label styling */
        .label {
            font-size: 14px;
            font-family: Arial, sans-serif;
            margin-left: 8px;
            font-weight: bold;
        }

        /* Wrapper styling */
        .indicator-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

    .calendar-day.half-day{
    background-color: #FFF9C4; /* Gray for no data */
    color: black;
}


</style>
<body>
<!--    <div class="header d-flex justify-content-between align-items-center">-->
<!--        <a href="{% url 'home' %}">-->
<!--            <img src="{% static 'images/HOME.png' %}" alt="Home">-->
<!--        </a>-->
<!--        <h1 style="font-size: 1.9rem; font-weight: bold;">ATTENDANCE CALENDAR</h1>-->
<!--        {% if user.is_authenticated %}-->
<!--            <h4>{{ user.username }} <img src="{% static 'images/R.png' %}" alt="User" style="width: 30px; height: 35px; border-radius: 4px;"></h4>-->
<!--        {% else %}-->
<!--            <h4>Welcome, Guest!</h4>-->
<!--        {% endif %}-->
<!--    </div>-->
    <br>
<div class="layout">
        <div class="sidebar">
            </br>
             <img src="{% static 'images/img_19.png' %}" alt="Responsive image" width="150" height="40">
            </br></br>
            {% if user.is_authenticated %}
            <h4 style="color: white; text-transform: uppercase;" align="center"><img  src="{% static 'images/R.png' %}" alt="User" style="width: 45px; height: 50px; border-radius: 16px;"></br>{{ user.username }} </h4><h6 align="center">{{ designation }}</h6>
        {% else %}
            <h4>Welcome, Guest!</h4>
        {% endif %}
</br></br></br>
<!--        <a href="{% url 'task_dashboard' %}" class="sidebar-link"><img src="{% static 'images/img_8.png' %}" width="40" height="40"><span class="sidebar-title">Dashboard</span></a>-->
        <a href="{% url 'calendar' %}" class="sidebar-link"><img src="{% static 'images/img_9.png' %}" width="40" height="40"><span class="sidebar-title">Attendance</span></a>
        <a href="{% url 'main_leave_page' %}" class="sidebar-link"><img src="{% static 'images/img_10.png' %}" width="40" height="40"><span class="sidebar-title">Leave Page</span></a>
        <a href="{% url 'task_dashboard' %}" class="sidebar-link"><img src="{% static 'images/img_11.png' %}" width="40" height="40"><span class="sidebar-title">View Tasks</span></a>
        <a href="{% url 'logouts' %}" class="sign-out sidebar-link"><img src="{% static 'images/img_12.png' %}" width="40" height="40">&nbsp;&nbsp;<span class="sidebar-title"> SignOut</span></a>
</div>
<!--            <div class="stats-sections">-->
<!--            <p style="background-color: #C8E6C9;">WORK FROM OFFICE</p>-->
<!--            <p style="background-color: #FFCDD2;">WORK FROM HOME</p>-->
<!--            <p style="background-color: #FFF9C4;">ON LEAVE</p>-->
<!--&lt;!&ndash;            <p style="background-color: white">NO DATA</p>&ndash;&gt;-->
<!--            <p style="background-color: white; border: 8px solid black;">TODAY</p>-->
<!--    </div>-->

<!--            <div class="details-box">-->
<!--                    <a href="{% url 'leave_application' %}"><h3><img src="{% static 'images/img_7.png' %}" width="20" height="20">&emsp;Settings</h3></a>-->
<!--                </div>-->
        </div>
<div class="main-content">
    <div class="top-bar">
    <!-- Clock section -->
    <div class="clock-section">
        </br>
         <div class="date" id="current-date"></div>
        <div class="time" id="current-time"></div>
    </div>
    <!-- Assigned timings section -->
    <div class="timing-section">
        <div>
            <h4><strong>Assigned Timings</strong></h4>
            <p>5 Days/Week</p>
            <div class="days-of-week">
                <div class="day">M</div>
                <div class="day">T</div>
                <div class="day">W</div>
                <div class="day">T</div>
                <div class="day">F</div>
                <div class="day1">S</div>
                <div class="day1">S</div>
            </div>
        </div>
        <div class="shift-details">
            <p>Regular Shift Work Time</p>
            &nbsp;<span>9:00 AM</span> &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&nbsp;<span>7:00 PM</span>
            <div class="shift-bar"><div class="break-bar"></div>
         <!-- The pink break bar -->
    </div>
    <!-- Start and End times for the shift -->
    <div class="time-labels">
        <p>Duration: <span>10.00 hrs</span></p>&emsp;
            <p>Break: <span>1.00 hr</span></p>
    </div>
        </div>
    </div>
    <div class="stats-section">
        <div class="stat">08:40</div>
        <div class="label">Avg Hours/Day</div>
        <div class="stat">{{ on_time_percentage }}%</div>
        <div class="label">On-Time Arrival</div>
    </div>
</div>
    <div class="right-sidebar">
                <div class="total-worktime">
        <strong>Monthly Hours: <span id="totalTime">{{ total_worktime }}/{{ expected_monthly_hours }}Hours</span></strong>
            <a class="btn btn-info btn-sm mx-1 " href="{% url 'clear_attendance' %}"><strong>Clear Records</strong></a>
<!--            <a id="toggleTimeFormat"></a>-->
    </div></br>
        <div>
        <h4>HOURS COMPLETED MONTHLY CURRENT WEEK</h4>
        <p align="center" style="color: black;">{{ weekly_worktime }}/{{ expected_weekly_hours }}Hours</p>
        <canvas id="weeklyWorktimeChart" width="230" height="200"></canvas>
            </div>
       </br>
        <div>
        <h4>HOURS COMPLETED MONTHLY TILL DATE</h4>
        <h6 align="center" style="color: black;">{{ total_worktime }}/{{ expected_monthly_hours }}Hours</h6>
        <canvas id="monthlyWorktimeChart" width="230" height="200"></canvas>
        </div>
    </div>
    <div class="container">
    <div class="d-flex justify-content-between align-items-right mb-4">
<!--        <div>-->
<!--            <a href="{% url 'home' %}">-->
<!--            <img src="{% static 'images/HOME.png' %}" width="35" height="35" style="border-radius: 8px; text-decoration: none;">-->
<!--            </a>-->
<!--            &nbsp;-->
<!--            <a class="btn btn-danger btn-sm mx-1 " href="{% url 'clear_attendance' %}"><strong>Clear Records</strong></a>-->
            <a id="toggleTimeFormat"></a>
<!--        </div>-->
    </div>
    <div class="month-nav">
        <button id="prevMonth">&LeftArrow;</button>
        <span id="currentMonth">{{ current_month_name }} {{ current_year }}</span>
        <button id="nextMonth">&RightArrow;</button>
    </div>
        <div id="indicator-container"></div>
        <br>
    <div class="calendar">
        <div class="calendar-header">Mon</div>
        <div class="calendar-header">Tue</div>
        <div class="calendar-header">Wed</div>
        <div class="calendar-header">Thu</div>
        <div class="calendar-header">Fri</div>
        <div class="calendar-header">Sat</div>
        <div class="calendar-header">Sun</div>
  {% for day in calendar_data %}
    <div class="calendar-day
        {% if day.day %} has-date{% endif %}
        {% if day.status == 'office' %} work-office
        {% elif day.status == 'wfh' %} work-home
        {% elif day.status == 'leave' %} leave-day
        {% elif day.status == 'weekend' %} weekend
        {% elif day.status == 'half-day' %} half-day
        {% else %} no-data {% endif %}
        {% if day.day == today.day and current_month == today.month and current_year == today.year %} today{% endif %}">

        <strong>{{ day.day }}</strong>

        <!-- Display office workday details -->
        {% if day.status == 'office' %}
            <div class="daily-time"><strong>{{ day.worktime }}</strong></div>
            <div class="daily-times">IN : {{ day.punch_in }}</div>
            <div class="daily-times">OUT : {{ day.punch_out }}</div>
            <div class="daily-times">BREAK : {{ day.break_time }}</div>
            <div class="daily-times">
                <a class="btn btn-info btn-sm mx-1" href="{% url 'edit_attendance' day.pk %}">
                    <img src="{% static 'images/img_5.png' %}" alt="Edit" width="15" height="15">
                </a>
                <a class="btn btn-sm mx-1 delete-button" style="background-color: rgb(255, 108, 108);" href="{% url 'delete_attendance' day.pk %}">
    <img src="{% static 'images/img_6.png' %}" alt="Delete" width="15" height="15">
</a>
            </div>

        <!-- Display WFH day details -->
        {% elif day.status == 'wfh' %}
            {% if day.pk %}
                <div class="daily-time"><strong>{{ day.worktime }}</strong></div>
                <div class="daily-times">IN : {{ day.punch_in }}</div>
                <div class="daily-times">OUT : {{ day.punch_out }}</div>
                <div class="daily-times">BREAK : {{ day.break_time }}</div>
                <div class="daily-times">
                    <a class="btn btn-info btn-sm mx-1" href="{% url 'edit_attendance' day.pk %}">
                        <img src="{% static 'images/img_5.png' %}" alt="Edit" width="15" height="15">
                    </a>
                    <a class="btn btn-sm mx-1 delete-button" style="background-color: rgb(255, 108, 108);" href="{% url 'delete_attendance' day.pk %}">
    <img src="{% static 'images/img_6.png' %}" alt="Delete" width="15" height="15">
</a>
                </div>
            {% else %}
                </br>
                <div class="daily-times"><a class="btn btn-outline-secondary" href="{% url 'attendance' %}">
                    <img src="{% static 'images/img_15.png' %}" alt="Add Data" width="35" height="35">
                </a></div>
            {% endif %}
        <!-- Display Half Day details -->
        {% elif day.status == 'half-day' %}
            {% if day.pk %}
                <div class="daily-time"><strong>{{ day.worktime }}</strong></div>
                <div class="daily-times">IN : {{ day.punch_in }}</div>
                <div class="daily-times">OUT : {{ day.punch_out }}</div>
                <div class="daily-times">BREAK : {{ day.break_time }}</div>
                <div class="daily-times">
                    <a class="btn btn-info btn-sm mx-1" href="{% url 'edit_attendance' day.pk %}">
                        <img src="{% static 'images/img_5.png' %}" alt="Edit" width="15" height="15">
                    </a>
                    <a class="btn btn-sm mx-1 delete-button" style="background-color: rgb(255, 108, 108);" href="{% url 'delete_attendance' day.pk %}">
    <img src="{% static 'images/img_6.png' %}" alt="Delete" width="15" height="15">
</a>
                </div>
            {% else %}
                </br>
                <div class="daily-times"><a class="btn btn-outline-secondary" href="{% url 'attendance' %}">
                    <img src="{% static 'images/img_15.png' %}" alt="Add Data" width="35" height="35">
                </a></div>
            {% endif %}
        <!-- Display Leave day details -->
        {% elif day.status == 'leave' %}
            <div class="daily-times"><strong>ON LEAVE</strong></div>
        <!-- Display Add Data button for no data days -->
        {% elif day.day %}
        </br>
            <div class="daily-times"><a class="btn btn-outline-secondary" href="{% url 'attendance' %}">
                <img src="{% static 'images/img_15.png' %}" alt="Add Data" width="35" height="35">
            </a></div>
        {% endif %}
    </div>
{% endfor %}
<script>
     const indicators = [
            { label: "WFH", color: "#FFCDD2" },
            { label: "FULLDAY/HALFDAY LEAVE", color: "#FFF9C4" },
            { label: "WORK FROM OFFICE", color: "#C8E6C9" },
            { label: "TODAY", color: "white", border: "4px solid black" }
        ];

        // Get the container
        const container = document.getElementById("indicator-container");

        // Loop through the indicators and create them dynamically
        indicators.forEach(indicator => {
            // Create a wrapper div for the circle and label
            const wrapper = document.createElement("div");
            wrapper.className = "indicator-wrapper";

            // Create the circle
            const circle = document.createElement("div");
            circle.className = "circle";
            circle.style.backgroundColor = indicator.color;

            // Apply border if specified
            if (indicator.border) {
                circle.style.border = indicator.border;
            }

            // Create the label
            const label = document.createElement("span");
            label.className = "label";
            label.textContent = indicator.label;

            // Append circle and label to the wrapper
            wrapper.appendChild(circle);
            wrapper.appendChild(label);

            // Append the wrapper to the containers
            container.appendChild(wrapper);
        });


    function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const date = now.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });

        document.getElementById('current-time').textContent = time;
        document.getElementById('current-date').textContent = date;

        // Highlight the current day
        const dayIndex = now.getDay(); // 0 = Sunday, 6 = Saturday
        const days = document.querySelectorAll('.day');
        days.forEach((day, index) => {
            if (index === dayIndex - 1) { // Adjust for Monday start
                day.classList.add('active');
            } else {
                day.classList.remove('active');
            }
        });
    }

    setInterval(updateClock, 1000);
    updateClock();

    document.addEventListener('DOMContentLoaded', function() {
        const totalTimeElement = document.getElementById('totalTime');
        const toggleTimeFormatButton = document.getElementById('toggleTimeFormat');
        const dailyTimeElements = document.querySelectorAll('.daily-time');
        let isHrMinFormat = false;

        toggleTimeFormatButton.addEventListener('click', function() {
            dailyTimeElements.forEach(element => {
                const timeText = element.textContent;
                if (isHrMinFormat) {
                    const [hours, minutes] = timeText.split(' hr ')[1].split(' min');
                    element.textContent = `${(parseInt(hours) + parseInt(minutes) / 60).toFixed(2)} hr`;
                } else {
                    const hr = parseFloat(timeText);
                    const totalMinutes = Math.floor(hr * 60);
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    element.textContent = `${hours} hr ${minutes} min`;
                }
            });
            isHrMinFormat = !isHrMinFormat;
        });

        document.getElementById('prevMonth').addEventListener('click', function() {
            window.location.href = "{% url 'calendar' %}?month={{ prev_month }}&year={{ prev_year }}";
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            window.location.href = "{% url 'calendar' %}?month={{ next_month }}&year={{ next_year }}";
        });
    });

    // ---- Monthly Worktime Chart ----

    // Total required hours for the month (e.g., 189 hours)
    const totalRequiredHours = {{ expected_monthly_hours }}

    // Completed hours (from total_worktime passed from the backend)
    const completedHours = {{ total_worktime }}; // Django variable

    // Remaining hours calculation
    const remainingHours = totalRequiredHours - completedHours;

    // Data for the monthly worktime chart
    const monthlyData = {
        labels: ['COMPLETED HOURS', 'REMAINING HOURS  '],
        datasets: [{
            data: [completedHours, remainingHours],
            backgroundColor: ['rgb(255, 157, 230)', 'rgb(207, 255, 243)'],
            borderColor: ['rgb(255, 157, 230)', 'rgb(207, 255, 243)'],
            borderWidth: 5
            // Green for completed, Light blue for remaining
        }]
    };

    // Options for the monthly worktime chart
    const monthlyOptions = {
        cutout: '31%', // For doughnut chart inner cutout
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    font: {
                        size: 15 // Adjust the font size for legend
                    },
                    color: function(context) {
                        // Custom color for the labels based on the index
                        return context. index === 0 ? 'black' : 'black'; // Green for Completed, Light blue for Remaining
                    }
                }
            },
        },
        responsive: true,
        maintainAspectRatio: true,
    };

    // Create the monthly worktime chart
    const ctxMonthly = document.getElementById('monthlyWorktimeChart').getContext('2d');
    new Chart(ctxMonthly, {
        type: 'doughnut',
        data: monthlyData,
        options: monthlyOptions
    });

    // ---- Weekly Worktime Chart ----

    // Get the weekly worktime and expected hours from Django context
    const completedWeeklyHours = {{ weekly_worktime }};
    const totalWeeklyHours = {{ expected_weekly_hours }};
    const remainingWeeklyHours = totalWeeklyHours - completedWeeklyHours;

    // Data for the weekly worktime chart
    const weeklyData = {
        labels: ['COMPLETED HOURS', 'REMAINING HOURS  '],
        datasets: [{
            data: [completedWeeklyHours, remainingWeeklyHours],
            backgroundColor: ['#FFDEB9', '#FFA4A4'], // Green for completed, Gray for remaining
            borderColor: ['#FFDEB9', '#FFA4A4'],
            borderWidth: 5
        }]
    };

    // Options for the weekly worktime chart
    const weeklyOptions = {
        responsive: true,
        cutout: '31%', // For doughnut chart inner cutout
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    font: {
                        size: 15 // Adjust the font size for legend
                    },
                    color: function(context) {
                        // Custom color for the labels based on the index
                        return context. index === 0 ? 'black' : 'black'; // Green for Completed, Gray for Remaining
                    }
                }
            },
        }
    };

    // Create the weekly worktime chart
    const ctxWeekly = document.getElementById('weeklyWorktimeChart').getContext('2d');
    new Chart(ctxWeekly, {
        type: 'doughnut',
        data: weeklyData,
        options: weeklyOptions
    });

document.addEventListener('DOMContentLoaded', function () {
    // Attach click event to all delete buttons
    const deleteButtons = document.querySelectorAll('.delete-button');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default link behavior
            const confirmation = confirm("Are you sure you want to delete this record?");
            if (confirmation) {
                // Proceed with the deletion
                window.location.href = this.href;
            }
        });
    });
});


</script>
<!--        WITHOUT CONFIRMATION-->
<!--$('#deleteModal').on('show.bs.modal', function(event) {-->
<!--    var button = $(event.relatedTarget); // Button that triggered the modal-->
<!--    var pk = button.data('pk'); // Extract primary key from data-* attributes-->
<!--    var modal = $(this);-->
<!--    modal.find('.modal-body input#delete_pk').val(pk); // Set the hidden input field-->
<!--    var action = "{% url 'delete_attendance' 0 %}".replace("0", pk); // Construct the form action URL-->
<!--    document.getElementById('deleteForm').action = action; // Set the form's action attribute-->
<!--});-->

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

